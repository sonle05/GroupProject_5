services:
  # --- H·∫† T·∫¶NG CHUNG (L√™ Ng·ªçc S∆°n qu·∫£n l√Ω) ---
  
  # üõí D·ªØ li·ªáu B√°n h√†ng (D√†nh cho module c·ªßa H√≤a v√† T√†i)
  mysql-store:
    image: mysql:8.0
    container_name: web-store-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: web_store
    ports:
      - "3306:3306"
    networks:
      - internal-bridge
    volumes:
      - store_data:/var/lib/mysql

  # üí∞ D·ªØ li·ªáu T√†i ch√≠nh (D√†nh cho module c·ªßa ƒê·ª©c)
  postgres-finance:
    image: postgres:15
    container_name: finance-db
    environment:
      POSTGRES_USER: finance_admin
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD} 
      POSTGRES_DB: finance_db
    ports:
      - "5432:5432"
    networks:
      - internal-bridge
    volumes:
      - finance_data:/var/lib/postgresql/data

  # üì© Message Broker (K·∫øt n·ªëi c√°c module c·ªßa T√†i, H√≤a, ƒê·ª©c)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: message-broker
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - internal-bridge

  # üõ°Ô∏è API Gateway (S∆°n qu·∫£n l√Ω ƒë·ªÉ b·∫£o m·∫≠t lu·ªìng ra v√†o)
  kong:
    image: kong:latest
    container_name: api-gateway
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - "8000:8000"
      - "8001:8001"
    networks:
      - internal-bridge
      - public-net
    volumes:
      - ./kong.yml:/usr/local/kong/declarative/kong.yml

  # --- C√ÅC MODULE C·ª¶A TH√ÄNH VI√äN (Gh√©p v√†o ƒë√¢y) ---

  # 1. Module ƒê·ªìng b·ªô kho - ƒê·ªó Thanh T√†i
  sync-service:
    build: ./module-1-sync
    container_name: module-sync
    depends_on:
      - mysql-store
      - rabbitmq
    networks:
      - internal-bridge

  # 2. Module X·ª≠ l√Ω ƒë∆°n h√†ng - Nguy·ªÖn Ph√∫ H√≤a
  orders-service:
    build: ./module-2-orders
    container_name: module-orders
    depends_on:
      - mysql-store
      - rabbitmq
    networks:
      - internal-bridge

  # 3. Module Trung t√¢m ch·ªâ huy - Nguy·ªÖn Th√†nh ƒê·ª©c
  control-center-service:
    build: ./module-3-control-center
    container_name: module-control
    depends_on:
      - postgres-finance
      - rabbitmq
    networks:
      - internal-bridge

networks:
  internal-bridge:
    driver: bridge
  public-net:
    driver: bridge

volumes:
  store_data:
  finance_data:
